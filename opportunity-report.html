<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†è«‡å ±å‘Š (ä¼šç¤¾æƒ…å ±å…¥åŠ›å¯¾å¿œç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: #f4f6f8; padding: 20px; color: #33475b; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; font-size: 20px; margin-bottom: 20px; font-weight: bold; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd6e2; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        input:focus, select:focus, textarea:focus { border-color: #ff7a59; outline: none; box-shadow: 0 0 0 3px rgba(255, 122, 89, 0.15); }

        .hidden { display: none; }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; font-size: 16px; }
        .btn-primary { background: #ff7a59; transition: 0.2s; }
        .btn-primary:hover { background: #e66b4d; }
        .btn-success { background: #00bf63; transition: 0.2s; }
        .btn-success:hover { background: #00a354; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        .step-badge { display: inline-block; background: #eaf0f6; padding: 4px 12px; border-radius: 20px; font-size: 12px; color: #516f90; margin-bottom: 15px; font-weight: bold; }
        .confirmed-box { background: #dff0d8; border: 1px solid #d0e9c6; color: #3c763d; padding: 15px; border-radius: 4px; margin-bottom: 25px; text-align: center; font-weight: bold; }
        
        /* Select2èª¿æ•´ */
        .select2-container .select2-selection--single { height: 46px !important; border: 1px solid #cbd6e2 !important; }
        .select2-selection__rendered { line-height: 46px !important; padding-left: 12px !important; }
        .select2-selection__arrow { height: 44px !important; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ æ–°è¦å•†è«‡å ±å‘Š</h1>

    <div id="step1">
        <div class="step-badge">STEP 1/2: ä¼šç¤¾æƒ…å ±ã®ç¢ºèªãƒ»ç™»éŒ²</div>
        
        <div class="form-group">
            <label>ä¼šç¤¾åã‚’æ¤œç´¢ã—ã¦ãã ã•ã„ <span style="color:red">*</span></label>
            <select id="companySearch" style="width: 100%;"></select>
        </div>

        <div id="companyDetailFields" class="hidden">
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            
            <div class="form-group hidden" id="newNameGroup">
                <label>ä¼šç¤¾å (æ­£å¼åç§°ã‚’å…¥åŠ›) <span style="color:red">*</span></label>
                <input type="text" id="companyNameNew" placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«">
            </div>

            <div class="form-group">
                <label>éƒ½é“åºœçœŒ</label>
                <select id="state">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
            </div>

            <div class="form-group">
                <label>æ¥­ç¨®</label>
                <input type="text" id="industry" placeholder="ä¾‹: è£½é€ æ¥­, ITé€šä¿¡...">
            </div>

            <div class="form-group">
                <label>è·ç¨®</label>
                <input type="text" id="job_type" placeholder="ä¾‹: å–¶æ¥­éƒ¨é•·, æ‹…å½“è€…...">
            </div>

            <div class="form-group">
                <label>çµŒè·¯ (Introduction) <span style="color:red">*</span></label>
                <select id="introduction">
                    <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
                </select>
            </div>

            <button class="btn btn-primary" id="btnStep1">ã“ã®ä¼šç¤¾æƒ…å ±ã§é€²ã‚€</button>
        </div>
        
        <div id="loading1" class="hidden" style="text-align:center; margin-top:15px; color:#666;">
            Processing... ä¼šç¤¾æƒ…å ±ã‚’ç™»éŒ²/æ›´æ–°ä¸­
        </div>
    </div>

    <div id="step2" class="hidden">
        <div class="step-badge">STEP 2/2: å•†è«‡ãƒ­ã‚°å…¥åŠ›</div>
        
        <div class="confirmed-box">
            âœ… ä¼šç¤¾ç¢ºå®š: <span id="confirmedCompanyName" style="font-size:1.2em;"></span>
        </div>

        <div class="form-group">
            <label>ç›¸è«‡ç™ºç”Ÿæ—¥ (Report Date) <span style="color:red">*</span></label>
            <input type="date" id="reportDate">
        </div>

        <div class="form-group">
            <label>å•†è«‡/ã‚³ãƒ¼ãƒ«å®Ÿæ–½æ—¥ (Meeting Date) <span style="color:red">*</span></label>
            <input type="date" id="meetingDate">
        </div>
        
        <div class="form-group">
            <label>æ´»å‹•ã‚¿ã‚¤ãƒ—</label>
            <div style="display:flex; gap:20px; margin-top:5px;">
                <label style="font-weight:normal; cursor:pointer; display:flex; align-items:center;">
                    <input type="radio" name="engType" value="MEETING" checked style="width:auto; margin-right:5px;"> ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°
                </label>
                <label style="font-weight:normal; cursor:pointer; display:flex; align-items:center;">
                    <input type="radio" name="engType" value="CALL" style="width:auto; margin-right:5px;"> ã‚³ãƒ¼ãƒ« (é›»è©±)
                </label>
            </div>
        </div>

        <div class="form-group">
            <label>ãƒ¡ãƒ¢ / è­°äº‹éŒ² <span style="color:red">*</span></label>
            <textarea id="notes" rows="5" placeholder="å•†è«‡ã®å†…å®¹ã€ãƒã‚¯ã‚¹ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãªã©ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
        </div>

        <button class="btn btn-success" id="btnStep2">å ±å‘Šã‚’å®Œäº†ã™ã‚‹</button>
        <div id="loading2" class="hidden" style="text-align:center; margin-top:15px; color:#666;">
            Sending... å•†è«‡ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ä¸­
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // â–¼ APIè¨­å®š
    const API_MASTER = 'https://kumamon-n8n.xvps.jp/webhook/get-master-data';
    const API_SEARCH = 'https://kumamon-n8n.xvps.jp/webhook/search-companies';
    const API_STEP1  = 'https://kumamon-n8n.xvps.jp/webhook/submit-company'; 
    const API_STEP2  = 'https://kumamon-n8n.xvps.jp/webhook/submit-deal';

    let CONFIRMED_COMPANY_ID = null;

    $(document).ready(function() {
        // æ—¥ä»˜åˆæœŸå€¤
        const today = new Date().toISOString().split('T')[0];
        $('#reportDate').val(today);
        $('#meetingDate').val(today);

        // éƒ½é“åºœçœŒãƒªã‚¹ãƒˆç”Ÿæˆ
        const prefectures = ["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"];
        prefectures.forEach(p => $('#state').append(`<option value="${p}">${p}</option>`));

        // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿(çµŒè·¯)å–å¾—
        $.get(API_MASTER, function(data) {
            const opts = data.properties.introduction || [];
            $('#introduction').empty().append('<option value="">é¸æŠã—ã¦ãã ã•ã„</option>');
            opts.forEach(o => $('#introduction').append(`<option value="${o.value}">${o.label}</option>`));
        }).fail(function() {
             $('#introduction').html('<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>');
        });

        // æ¤œç´¢æ©Ÿèƒ½ (Select2)
        $('#companySearch').select2({
            placeholder: 'ä¼šç¤¾åã‚’å…¥åŠ›ã—ã¦æ¤œç´¢...',
            allowClear: true,
            minimumInputLength: 2,
            ajax: {
                url: API_SEARCH,
                dataType: 'json',
                delay: 300,
                data: params => ({ q: params.term }),
                processResults: data => {
                    const res = data.results || [];
                    res.unshift({ id: '_new_', text: 'â• æ–°è¦ä¼šç¤¾ã¨ã—ã¦ç™»éŒ²' });
                    return { results: res };
                }
            }
        });

        // é¸æŠæ™‚ã®æŒ™å‹•
        $('#companySearch').on('select2:select', function(e) {
            const selectedId = e.params.data.id;
            $('#companyDetailFields').removeClass('hidden');
            if(selectedId === '_new_') {
                $('#newNameGroup').removeClass('hidden');
                $('#companyNameNew').focus();
            } else {
                $('#newNameGroup').addClass('hidden');
            }
        });

        $('#companySearch').on('select2:clear', function() {
            $('#companyDetailFields').addClass('hidden');
            $('#newNameGroup').addClass('hidden');
        });

        // --- STEP 1: ä¼šç¤¾ç¢ºå®šãƒœã‚¿ãƒ³ ---
        $('#btnStep1').click(function() {
            const companyId = $('#companySearch').val();
            if(!companyId) return alert("ä¼šç¤¾ã‚’é¸æŠã—ã¦ãã ã•ã„");

            // è¡¨ç¤ºç”¨ä¼šç¤¾åã®æ±ºå®š
            let displayCompanyName = "";
            let apiPayloadName = ""; 

            if(companyId === '_new_') {
                const manualName = $('#companyNameNew').val();
                if(!manualName) return alert("ä¼šç¤¾å(æ­£å¼åç§°)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                displayCompanyName = manualName;
                apiPayloadName = manualName;
            } else {
                const data = $('#companySearch').select2('data');
                if(data && data[0]) {
                    displayCompanyName = data[0].text.replace(/\s*\(.*\)$/, ''); 
                }
            }

            const payload = {
                company_id: companyId,
                company_name_new: apiPayloadName,
                state: $('#state').val(),
                industry_occupation: $('#industry').val(),
                job_type: $('#job_type').val(),
                introduction: $('#introduction').val()
            };

            $(this).prop('disabled', true);
            $('#loading1').removeClass('hidden');

            $.ajax({
                url: API_STEP1,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(res) {
                    // â˜…IDå–å¾—ãƒã‚§ãƒƒã‚¯ï¼ˆã“ã“ãŒé‡è¦ï¼‰
                    if (!res.company_id) {
                        alert("ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ä¼šç¤¾IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nã‚‚ã†ä¸€åº¦è©¦ã™ã‹ã€ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚");
                        $('#btnStep1').prop('disabled', false);
                        $('#loading1').addClass('hidden');
                        return;
                    }

                    // IDç¢ºä¿
                    CONFIRMED_COMPANY_ID = res.company_id;
                    
                    // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
                    $('#step1').addClass('hidden');
                    $('#step2').removeClass('hidden');
                    $('#confirmedCompanyName').text(displayCompanyName);
                },
                error: function(xhr) {
                    console.error(xhr);
                    alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                    $('#btnStep1').prop('disabled', false);
                    $('#loading1').addClass('hidden');
                }
            });
        });

        // --- STEP 2: å•†è«‡ç™»éŒ²ãƒœã‚¿ãƒ³ ---
        $('#btnStep2').click(function() {
            if(!CONFIRMED_COMPANY_ID) return alert("ã‚¨ãƒ©ãƒ¼: ä¼šç¤¾IDãŒå¤±ã‚ã‚Œã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");

            const payload = {
                company_id: CONFIRMED_COMPANY_ID,
                company_name: $('#confirmedCompanyName').text(),
                report_date: $('#reportDate').val(),
                meeting_date: $('#meetingDate').val(),
                engagement_type: $('input[name="engType"]:checked').val(),
                meeting_notes: $('#notes').val()
            };

            if(!payload.report_date || !payload.meeting_date || !payload.meeting_notes) {
                return alert("å¿…é ˆé …ç›®ï¼ˆæ—¥ä»˜ã€ãƒ¡ãƒ¢ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            }

            $(this).prop('disabled', true);
            $('#loading2').removeClass('hidden');

            $.ajax({
                url: API_STEP2,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function() {
                    alert("âœ… å•†è«‡å ±å‘ŠãŒå®Œäº†ã—ã¾ã—ãŸï¼");
                    location.reload();
                },
                error: function() {
                    alert("å•†è«‡ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                    $('#btnStep2').prop('disabled', false);
                    $('#loading2').addClass('hidden');
                }
            });
        });
    });
</script>
</body>
</html>
