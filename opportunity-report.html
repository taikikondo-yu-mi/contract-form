<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†è«‡å ±å‘Š (2ã‚¹ãƒ†ãƒƒãƒ—ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body { font-family: sans-serif; background: #f4f6f8; padding: 20px; color: #33475b; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; font-size: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd6e2; border-radius: 4px; box-sizing: border-box; }
        .hidden { display: none; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; }
        .btn-primary { background: #ff7a59; }
        .btn-success { background: #00bf63; }
        .step-badge { display: inline-block; background: #eaf0f6; padding: 4px 10px; border-radius: 20px; font-size: 12px; color: #516f90; margin-bottom: 10px; }
        .confirmed-box { background: #dff0d8; border: 1px solid #d0e9c6; color: #3c763d; padding: 10px; border-radius: 4px; margin-bottom: 20px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ å•†è«‡å ±å‘Š</h1>

    <div id="step1">
        <div class="step-badge">STEP 1/2</div>
        <div class="form-group">
            <label>ä¼šç¤¾å (æ¤œç´¢/æ–°è¦)</label>
            <select id="companySearch" style="width: 100%;"></select>
        </div>

        <div id="newCompanyFields" class="hidden">
            <div class="form-group"><label>ä¼šç¤¾å (æ­£å¼åç§°)</label><input type="text" id="companyNameNew"></div>
            <div class="form-group">
                <label>éƒ½é“åºœçœŒ</label>
                <select id="state">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
                    <option value="å¤§é˜ªåºœ">å¤§é˜ªåºœ</option>
                    </select>
            </div>
            <div class="form-group"><label>æ¥­ç¨®</label><input type="text" id="industry"></div>
            <div class="form-group"><label>è·ç¨®</label><input type="text" id="job_type"></div>
            <div class="form-group">
                <label>çµŒè·¯</label>
                <select id="introduction"><option value="">èª­ã¿è¾¼ã¿ä¸­...</option></select>
            </div>
        </div>

        <button class="btn btn-primary" id="btnStep1">æ¬¡ã¸ï¼ˆä¼šç¤¾ã‚’ç¢ºå®šï¼‰</button>
        <div id="loading1" class="hidden" style="text-align:center; margin-top:10px;">å‡¦ç†ä¸­...</div>
    </div>

    <div id="step2" class="hidden">
        <div class="step-badge">STEP 2/2</div>
        <div class="confirmed-box">
            âœ… ä¼šç¤¾ç¢ºå®š: <strong id="confirmedCompanyName"></strong>
        </div>

        <div class="form-group"><label>ç›¸è«‡ç™ºç”Ÿæ—¥</label><input type="date" id="reportDate"></div>
        <div class="form-group"><label>å•†è«‡/ã‚³ãƒ¼ãƒ«å®Ÿæ–½æ—¥</label><input type="date" id="meetingDate"></div>
        
        <div class="form-group">
            <label>æ´»å‹•ã‚¿ã‚¤ãƒ—</label>
            <div>
                <label style="display:inline; margin-right:15px;"><input type="radio" name="engType" value="MEETING" checked> ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°</label>
                <label style="display:inline;"><input type="radio" name="engType" value="CALL"> ã‚³ãƒ¼ãƒ«</label>
            </div>
        </div>

        <div class="form-group"><label>ãƒ¡ãƒ¢</label><textarea id="notes" rows="4"></textarea></div>

        <button class="btn btn-success" id="btnStep2">å ±å‘Šã‚’å®Œäº†ã™ã‚‹</button>
        <div id="loading2" class="hidden" style="text-align:center; margin-top:10px;">é€ä¿¡ä¸­...</div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // â–¼ APIè¨­å®š
    const API_MASTER = 'https://kumamon-n8n.xvps.jp/webhook/get-master-data';
    const API_SEARCH = 'https://kumamon-n8n.xvps.jp/webhook/search-companies';
    const API_STEP1  = 'https://kumamon-n8n.xvps.jp/webhook/submit-company'; // ä¼šç¤¾ä½œæˆ
    const API_STEP2  = 'https://kumamon-n8n.xvps.jp/webhook/submit-deal';    // å•†è«‡ä½œæˆ

    // ç¢ºå®šã—ãŸä¼šç¤¾IDã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°
    let CONFIRMED_COMPANY_ID = null;

    $(document).ready(function() {
        // æ—¥ä»˜åˆæœŸå€¤
        const today = new Date().toISOString().split('T')[0];
        $('#reportDate').val(today);
        $('#meetingDate').val(today);

        // ãƒã‚¹ã‚¿å–å¾—
        $.get(API_MASTER, function(data) {
            const opts = data.properties.introduction || [];
            $('#introduction').empty().append('<option value="">é¸æŠã—ã¦ãã ã•ã„</option>');
            opts.forEach(o => $('#introduction').append(`<option value="${o.value}">${o.label}</option>`));
        });

        // æ¤œç´¢
        $('#companySearch').select2({
            placeholder: 'ä¼šç¤¾åæ¤œç´¢...',
            ajax: {
                url: API_SEARCH,
                dataType: 'json',
                data: params => ({ q: params.term }),
                processResults: data => {
                    const res = data.results || [];
                    res.unshift({ id: '_new_', text: 'â• æ–°è¦ç™»éŒ²' });
                    return { results: res };
                }
            }
        });

        // æ–°è¦é¸æŠæ™‚ã®è¡¨ç¤ºåˆ‡æ›¿
        $('#companySearch').on('select2:select', function(e) {
            if(e.params.data.id === '_new_') {
                $('#newCompanyFields').removeClass('hidden');
            } else {
                $('#newCompanyFields').addClass('hidden');
            }
        });

        // --- STEP 1: ä¼šç¤¾ç¢ºå®š ---
        $('#btnStep1').click(function() {
            const companyId = $('#companySearch').val();
            if(!companyId) return alert("ä¼šç¤¾ã‚’é¸æŠã—ã¦ãã ã•ã„");

            // â˜…ä¿®æ­£ç‚¹: è¡¨ç¤ºç”¨ã®ä¼šç¤¾åã‚’ã“ã“ã§ç¢ºå®šã•ã›ã‚‹
            let displayCompanyName = "";
            
            // æ–°è¦ä½œæˆã®å ´åˆ
            if(companyId === '_new_') {
                displayCompanyName = $('#companyNameNew').val();
                if(!displayCompanyName) return alert("ä¼šç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            } 
            // æ—¢å­˜é¸æŠã®å ´åˆ
            else {
                // Select2ã§é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
                const data = $('#companySearch').select2('data');
                if(data && data[0]) {
                    displayCompanyName = data[0].text;
                    // ãƒ‰ãƒ¡ã‚¤ãƒ³è¡¨è¨˜ (toyota.co.jp) ãªã©ã‚’é™¤å»ã—ã¦ç¶ºéº—ã«ã™ã‚‹
                    displayCompanyName = displayCompanyName.replace(/\s*\(.*\)$/, '');
                }
            }

            const payload = {
                company_id: companyId,
                company_name_new: $('#companyNameNew').val(),
                state: $('#state').val(),
                industry_occupation: $('#industry').val(),
                job_type: $('#job_type').val(),
                introduction: $('#introduction').val()
            };

            // UIå¤‰æ›´
            $(this).prop('disabled', true);
            $('#loading1').removeClass('hidden');

            $.ajax({
                url: API_STEP1,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(res) {
                    // IDç¢ºä¿
                    CONFIRMED_COMPANY_ID = res.company_id;
                    
                    // â˜…ä¿®æ­£ç‚¹: APIã®è¿”å´å€¤ã‚’ä½¿ã‚ãšã€è‡ªåˆ†ã§ç¢ºä¿ã—ãŸåå‰ã‚’è¡¨ç¤ºã™ã‚‹
                    // ï¼ˆã“ã‚Œã§ [object Object] ã«ãªã‚‹ã®ã‚’é˜²ãï¼‰
                    
                    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
                    $('#step1').addClass('hidden');
                    $('#step2').removeClass('hidden');
                    $('#confirmedCompanyName').text(displayCompanyName); // ï¼œã“ã“ã‚’ä¿®æ­£ã—ã¾ã—ãŸ
                },
                error: function() {
                    alert("ä¼šç¤¾æƒ…å ±ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");
                    $('#btnStep1').prop('disabled', false);
                    $('#loading1').addClass('hidden');
                }
            });
        });

        // --- STEP 2: å•†è«‡ç™»éŒ² ---
        $('#btnStep2').click(function() {
            if(!CONFIRMED_COMPANY_ID) return alert("ä¼šç¤¾IDãŒä¸æ˜ã§ã™ã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„");

            const payload = {
                company_id: CONFIRMED_COMPANY_ID,
                company_name: $('#confirmedCompanyName').text(), // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ­£ã—ã„åå‰ã‚’é€ã‚‹
                report_date: $('#reportDate').val(),
                meeting_date: $('#meetingDate').val(),
                engagement_type: $('input[name="engType"]:checked').val(),
                meeting_notes: $('#notes').val()
            };

            $(this).prop('disabled', true);
            $('#loading2').removeClass('hidden');

            $.ajax({
                url: API_STEP2,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function() {
                    alert("âœ… å ±å‘ŠãŒå®Œäº†ã—ã¾ã—ãŸï¼");
                    location.reload();
                },
                error: function() {
                    alert("å•†è«‡ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");
                    $('#btnStep2').prop('disabled', false);
                    $('#loading2').addClass('hidden');
                }
            });
        });
    });
</script>
</body>
</html>
