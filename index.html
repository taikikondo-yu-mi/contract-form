<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥‘ç´„ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ </title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .form-title {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 2rem;
            text-align: center;
        }
        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid #f0f0f0;
        }
        .form-section:last-of-type {
            border-bottom: none;
        }
        .section-title {
            color: #764ba2;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
        }
        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 1rem 3rem;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 50px;
            transition: transform 0.2s;
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        .alert {
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        .result-item {
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 0.75rem;
        }
        .result-label {
            font-weight: 600;
            color: #667eea;
            margin-right: 0.5rem;
        }
        .select2-container {
            width: 100% !important;
        }
        .required-mark {
            color: #dc3545;
            margin-left: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <h1 class="form-title">ğŸ“ å¥‘ç´„ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ </h1>
            
            <form id="contractForm">
                <!-- ä¼šç¤¾æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="form-section">
                    <h2 class="section-title">ğŸ¢ ä¼šç¤¾æƒ…å ±</h2>
                    
                    <div class="mb-3">
                        <label for="company" class="form-label">
                            ä¼šç¤¾å<span class="required-mark">*</span>
                        </label>
                        <select id="company" name="company_id" class="form-select" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                    
                    <div id="newCompanyInput" style="display: none;">
                        <div class="mb-3">
                            <label for="new_company_name" class="form-label">
                                æ–°è¦ä¼šç¤¾å<span class="required-mark">*</span>
                            </label>
                            <input type="text" class="form-control" id="new_company_name" name="new_company_name" placeholder="æ ªå¼ä¼šç¤¾ã€‡ã€‡">
                        </div>
                    </div>
                </div>

                <!-- æ‹…å½“è€…æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="form-section">
                    <h2 class="section-title">ğŸ‘¥ æ‹…å½“è€…æƒ…å ±</h2>
                    
                    <div class="mb-3">
                        <label for="deal_owner" class="form-label">
                            å–å¼•æ‹…å½“è€…<span class="required-mark">*</span>
                        </label>
                        <select id="deal_owner" name="deal_owner" class="form-select" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="pm" class="form-label">
                            PM (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼)<span class="required-mark">*</span>
                        </label>
                        <select id="pm" name="pm" class="form-select" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="director" class="form-label">
                            ãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼<span class="required-mark">*</span>
                        </label>
                        <select id="director" name="director" class="form-select" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="assistant" class="form-label">
                            ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ<span class="required-mark">*</span>
                        </label>
                        <select id="assistant" name="assistant" class="form-select" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                </div>

                <!-- å¥‘ç´„æ›¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="form-section">
                    <h2 class="section-title">ğŸ“„ å¥‘ç´„æ›¸</h2>
                    
                    <div class="mb-3">
                        <label for="contract_file" class="form-label">
                            å¥‘ç´„æ›¸PDF (ä»»æ„)
                        </label>
                        <input type="file" class="form-control" id="contract_file" name="contract_file" accept=".pdf">
                        <div class="form-text">PDFãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™</div>
                    </div>
                </div>

                <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-submit">
                        âœ¨ å¥‘ç´„ã‚’ç™»éŒ²ã™ã‚‹
                    </button>
                </div>
            </form>

            <!-- æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="successMessage" class="alert alert-success" style="display: none;">
                <h4 class="alert-heading">âœ… å¥‘ç´„ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ!</h4>
                <hr>
                <div class="result-item">
                    <span class="result-label">Company ID:</span>
                    <span id="companyIdDisplay">N/A</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Deal ID:</span>
                    <span id="dealIdDisplay">N/A</span>
                </div>
                <div class="result-item">
                    <span class="result-label">å¥‘ç´„æ›¸:</span>
                    <span id="fileDisplay">æœªæ·»ä»˜</span>
                </div>
            </div>

            <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="errorMessage" class="alert alert-danger" style="display: none;">
                <h4 class="alert-heading">âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h4>
                <p id="errorDetails"></p>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        // ========================================
        // è¨­å®š
        // ========================================
        const API_BASE = 'https://kumamon-n8n.xvps.jp/webhook';
        const HUBSPOT_ACCOUNT_ID = '48328782';

        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        $(document).ready(function() {
            console.log('ğŸš€ ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–é–‹å§‹');
            
            // Select2 åˆæœŸåŒ–
            initializeSelect2();
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadFormData();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            setupEventListeners();
        });

        // ========================================
        // Select2 åˆæœŸåŒ–
        // ========================================
        function initializeSelect2() {
            const select2Config = {
                theme: 'bootstrap-5',
                placeholder: 'é¸æŠã—ã¦ãã ã•ã„',
                allowClear: true,
                width: '100%'
            };

            $('#company').select2(select2Config);
            $('#deal_owner').select2(select2Config);
            $('#pm').select2(select2Config);
            $('#director').select2(select2Config);
            $('#assistant').select2(select2Config);
            
            console.log('âœ… Select2 åˆæœŸåŒ–å®Œäº†');
        }

        // ========================================
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        // ========================================
        async function loadFormData() {
            try {
                console.log('ğŸ“¥ ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...');
                
                const response = await fetch(`${API_BASE}/get-form-data`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('ğŸ“¦ å–å¾—ãƒ‡ãƒ¼ã‚¿:', data);
                
                // ä¼šç¤¾ãƒªã‚¹ãƒˆ
                if (data.companies) {
                    $('#company').append('<option value="_new_">ã€æ–°è¦ä½œæˆã€‘</option>');
                    data.companies.forEach(company => {
                        $('#company').append(
                            `<option value="${company.id}">${company.name}</option>`
                        );
                    });
                    console.log(`âœ… ä¼šç¤¾: ${data.companies.length}ä»¶`);
                }
                
                // ã‚ªãƒ¼ãƒŠãƒ¼ãƒªã‚¹ãƒˆ
                if (data.owners) {
                    data.owners.forEach(owner => {
                        const option = `<option value="${owner.id}">${owner.name}</option>`;
                        $('#deal_owner').append(option);
                        $('#pm').append(option);
                        $('#director').append(option);
                        $('#assistant').append(option);
                    });
                    console.log(`âœ… ã‚ªãƒ¼ãƒŠãƒ¼: ${data.owners.length}ä»¶`);
                }
                
                console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');
                
            } catch (error) {
                console.error('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // ========================================
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        // ========================================
        function setupEventListeners() {
            // ä¼šç¤¾é¸æŠæ™‚ã®å‡¦ç†
            $('#company').on('change', function() {
                const isNewCompany = $(this).val() === '_new_';
                const newCompanyInput = document.getElementById('newCompanyInput');
                const newCompanyField = document.getElementById('new_company_name');
                
                if (isNewCompany) {
                    newCompanyInput.style.display = 'block';
                    newCompanyField.required = true;
                } else {
                    newCompanyInput.style.display = 'none';
                    newCompanyField.required = false;
                    newCompanyField.value = '';
                }
            });

            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
            document.getElementById('contractForm').addEventListener('submit', handleFormSubmit);
        }

        // ========================================
        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        // ========================================
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'é€ä¿¡ä¸­...';
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            try {
                // ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä½œæˆ
                const payload = await createPayload();
                console.log('ğŸ“¤ é€ä¿¡ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰:', payload);
                
                // APIé€ä¿¡
                const response = await fetch(`${API_BASE}/submit-contract-v2`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log('ğŸ“¥ APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);
                
                if (response.ok && result.success) {
                    // æˆåŠŸæ™‚ã®å‡¦ç†
                    handleSuccess(result);
                } else {
                    throw new Error(result.error || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error);
                handleError(error);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        }

        // ========================================
        // ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä½œæˆ
        // ========================================
        async function createPayload() {
            const formData = new FormData(document.getElementById('contractForm'));
            
            // åŸºæœ¬ãƒ‡ãƒ¼ã‚¿
            const payload = {
                company_id: formData.get('company_id'),
                company_name: getCompanyName(formData),
                deal_owner: formData.get('deal_owner'),
                deal_owner_name: $('#deal_owner').find(':selected').text(),
                pm: formData.get('pm'),
                pm_name: $('#pm').find(':selected').text(),
                director: formData.get('director'),
                director_name: $('#director').find(':selected').text(),
                assistant: formData.get('assistant'),
                assistant_name: $('#assistant').find(':selected').text()
            };
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
            const fileInput = document.getElementById('contract_file');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const base64 = await fileToBase64(file);
                
                payload.contract_file = {
                    name: file.name,
                    data: base64
                };
                
                console.log('ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜:', file.name);
            }
            
            return payload;
        }

        // ========================================
        // ä¼šç¤¾åå–å¾—
        // ========================================
        function getCompanyName(formData) {
            const companyId = formData.get('company_id');
            
            if (companyId === '_new_') {
                return formData.get('new_company_name');
            } else {
                return $('#company').find(':selected').text();
            }
        }

        // ========================================
        // ãƒ•ã‚¡ã‚¤ãƒ« â†’ Base64 å¤‰æ›
        // ========================================
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ========================================
        // æˆåŠŸæ™‚ã®å‡¦ç†
        // ========================================
        function handleSuccess(result) {
            console.log('âœ… ç™»éŒ²æˆåŠŸ:', result);
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            document.getElementById('successMessage').style.display = 'block';
            
            // Company ID
            document.getElementById('companyIdDisplay').textContent = 
                result.company_id || 'N/A';
            
            // Deal ID
            document.getElementById('dealIdDisplay').textContent = 
                result.deal_id || 'N/A';
            
            // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
            const fileDisplay = document.getElementById('fileDisplay');
            if (result.file_name && result.file_url) {
                fileDisplay.innerHTML = `
                    <a href="${result.file_url}" target="_blank" class="text-decoration-none">
                        ğŸ“„ ${result.file_name}
                    </a>
                `;
            } else {
                fileDisplay.textContent = 'æœªæ·»ä»˜';
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            resetForm();
            
            // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ========================================
        // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
        // ========================================
        function handleError(error) {
            console.error('âŒ ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
            
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorDetails').textContent = error.message;
            
            // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ========================================
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        // ========================================
        function resetForm() {
            document.getElementById('contractForm').reset();
            
            // Select2 ãƒªã‚»ãƒƒãƒˆ
            $('#company').val(null).trigger('change');
            $('#deal_owner').val(null).trigger('change');
            $('#pm').val(null).trigger('change');
            $('#director').val(null).trigger('change');
            $('#assistant').val(null).trigger('change');
            
            // æ–°è¦ä¼šç¤¾å…¥åŠ›æ¬„ã‚’éè¡¨ç¤º
            document.getElementById('newCompanyInput').style.display = 'none';
            document.getElementById('new_company_name').required = false;
        }
    </script>
</body>
</html>
